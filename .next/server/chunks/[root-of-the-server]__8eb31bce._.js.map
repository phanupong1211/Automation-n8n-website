{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/phanu/Automation-n8n%2Bwebiste/Automation-n8n%2Bwebiste/src/app/api/sse/route.ts"],"sourcesContent":["//sse\nimport { NextRequest } from \"next/server\";\n\n// Store for SSE connections\nconst connections = new Map<string, ReadableStreamDefaultController>();\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const sessionId = searchParams.get('sessionId') || Date.now().toString();\n\n    console.log(`SSE connection established for session: ${sessionId}`);\n\n    const stream = new ReadableStream({\n      start(controller) {\n        try {\n          // Store the connection\n          connections.set(sessionId, controller);\n\n          // Send initial connection message\n          controller.enqueue(`data: ${JSON.stringify({\n            type: 'connected',\n            sessionId,\n            message: 'เชื่อมต่อ AI สำเร็จ'\n          })}\\n\\n`);\n\n          console.log(`SSE initial message sent for session: ${sessionId}`);\n\n          // Clean up on close\n          request.signal.addEventListener('abort', () => {\n            console.log(`SSE connection closed for session: ${sessionId}`);\n            connections.delete(sessionId);\n            try {\n              controller.close();\n            } catch (e) {\n              // Connection already closed\n            }\n          });\n        } catch (error) {\n          console.error('Error in SSE stream start:', error);\n          connections.delete(sessionId);\n        }\n      },\n    });\n\n    return new Response(stream, {\n      headers: {\n        'Content-Type': 'text/event-stream',\n        'Cache-Control': 'no-cache',\n        'Connection': 'keep-alive',\n        'Access-Control-Allow-Origin': '*',\n        'Access-Control-Allow-Methods': 'GET',\n        'Access-Control-Allow-Headers': 'Cache-Control',\n        'X-Accel-Buffering': 'no', // Disable nginx buffering\n      },\n    });\n  } catch (error) {\n    console.error('Error in SSE GET handler:', error);\n    return new Response('SSE Error', { status: 500 });\n  }\n}\n\n// Function to send message to specific session\nexport function sendToSession(sessionId: string, data: any) {\n  console.log(`[SSE] Attempting to send to session: ${sessionId}`);\n  console.log(`[SSE] Available connections:`, Array.from(connections.keys()));\n  console.log(`[SSE] Total connections: ${connections.size}`);\n\n  const controller = connections.get(sessionId);\n  if (controller) {\n    try {\n      controller.enqueue(`data: ${JSON.stringify(data)}\\n\\n`);\n      console.log(`[SSE] Successfully sent message to session: ${sessionId}`);\n      return true;\n    } catch (error) {\n      console.error(`[SSE] Error sending to session ${sessionId}:`, error);\n      connections.delete(sessionId);\n      return false;\n    }\n  } else {\n    console.log(`[SSE] No connection found for session: ${sessionId}`);\n    console.log(`[SSE] Searching for partial matches...`);\n\n    // Try to find partial matches in case of session ID mismatch\n    for (const [connId, controller] of connections.entries()) {\n      if (connId.includes(sessionId) || sessionId.includes(connId)) {\n        console.log(`[SSE] Found partial match: ${connId} for ${sessionId}`);\n        try {\n          controller.enqueue(`data: ${JSON.stringify(data)}\\n\\n`);\n          console.log(`[SSE] Successfully sent message to partial match: ${connId}`);\n          return true;\n        } catch (error) {\n          console.error(`[SSE] Error sending to partial match ${connId}:`, error);\n          connections.delete(connId);\n        }\n      }\n    }\n  }\n  return false;\n}\n\n// Function to broadcast to all connections\nexport function broadcast(data: any) {\n  let sent = 0;\n  for (const [sessionId, controller] of connections.entries()) {\n    try {\n      controller.enqueue(`data: ${JSON.stringify(data)}\\n\\n`);\n      sent++;\n    } catch (error) {\n      console.error('Error broadcasting to session:', sessionId, error);\n      connections.delete(sessionId);\n    }\n  }\n  return sent;\n}\n\n// Function to get connection info for debugging\nexport function getConnectionInfo() {\n  return {\n    totalConnections: connections.size,\n    sessionIds: Array.from(connections.keys())\n  };\n}\n\n// Add a POST endpoint for debugging SSE connections\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { action, sessionId, testData } = body;\n\n    if (action === 'debug') {\n      const info = getConnectionInfo();\n      console.log(`[SSE Debug] Connection info:`, info);\n      return new Response(JSON.stringify({\n        success: true,\n        connectionInfo: info,\n        timestamp: new Date().toISOString()\n      }), {\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    if (action === 'test' && sessionId) {\n      const testMessage = testData || { type: 'test', message: 'Test message from debug endpoint' };\n      const sent = sendToSession(sessionId, testMessage);\n      return new Response(JSON.stringify({\n        success: sent,\n        message: sent ? 'Test message sent successfully' : 'Failed to send test message',\n        sessionId,\n        connectionInfo: getConnectionInfo()\n      }), {\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    return new Response(JSON.stringify({\n      error: 'Invalid action. Use \"debug\" or \"test\"'\n    }), {\n      status: 400,\n      headers: { 'Content-Type': 'application/json' }\n    });\n\n  } catch (error) {\n    console.error('SSE POST error:', error);\n    return new Response(JSON.stringify({\n      error: 'Failed to process request'\n    }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json' }\n    });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}